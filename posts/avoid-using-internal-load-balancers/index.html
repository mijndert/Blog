<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="Eleventy v2.0.1">
    <title>Avoid using internal load balancers</title>
    <meta name="description" content="On avoiding internal load balancers in liue of AWS CloudMap." />
    <link rel="alternate" type="application/rss+xml" href="https://mijndertstuij.nl/feed.xml" />
    <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
    <link rel="manifest" href="favicon/site.webmanifest">
    <link rel="stylesheet" href="/css/base.css" />
    <style>@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap')</style>
  </head>
  <body>
    <header>
  <a class="muted" href="/">Mijndert Stuij</a>
</header>
    <main>
      
<h1>Avoid using internal load balancers</h1>
<p class="muted">2022.03.15</p>
<article><p>One of the most well-known patterns in infrastructure is having an internal load balancer in front of backend services like application servers. When you're migrating your workloads to say AWS Fargate it's easy to just carry over that same pattern because, well, it works. But, as with all things in the cloud, internal load balancers cost money and add complexity. When you're just migrating to using containers for the first time, adding complexity to an already steep learning curve might not be the best way to go about things.</p>
<p>That's where <em>Service Discovery</em> comes in.</p>
<p>Service Discovery is a thing where you let the backend servers register themselves in some kind of database, so the requestor knows where the targets are. This has been done in all kinds of scenarios; from DHCP to XMPP, as well as DNS in Kubernetes.</p>
<p>While I agree that adding Service Discovery to your architecture does add a little bit of an up-front learning curve, in the long run it's kind of a set-and-forget thing.</p>
<p>A great service for such a use-case is <a href="https://aws.amazon.com/cloud-map/">AWS CloudMap</a> which integrates really well with AWS Fargate. Say you have a backend service running on AWS Fargate that accepts traffic on port 4000 that you can to be able to horizontally scale, it's pretty easy to implement in CloudFormation.</p>
<p>First we need to create a namespace to register targets in.</p>
<pre><code>PrivateNamespace:
  Type: AWS::ServiceDiscovery::PrivateDnsNamespace
  Properties:
    Name: my-backend-service.aws
    Vpc: !Ref VPCId
</code></pre>
<p>Now we can create a Service which is a collection of backend servers that Fargate knows how to register itself into.</p>
<pre><code>DiscoveryService:
  Type: AWS::ServiceDiscovery::Service
  Properties:
    Description: Discovery Service for my-backend-service
    DnsConfig:
      RoutingPolicy: MULTIVALUE
      DnsRecords:
        - TTL: 0
          Type: A
        - TTL: 0
          Type: SRV
    HealthCheckCustomConfig:
      FailureThreshold: 1
    Name: app
    NamespaceId: !Ref PrivateNamespace
</code></pre>
<p>To connect your Fargate service (<code>AWS::ECS::Service</code>) to CloudMap we can simply specify the DiscoveryService resource.</p>
<pre><code>ServiceRegistries:
  - RegistryArn: !GetAtt DiscoveryService.Arn
    Port: 4000
</code></pre>
<p>Anyone who needs to access your backend server can now simply use the hostname <code>app.my-backend-service.aws:4000</code> without every having to deploy a load balancer.</p>
<p>Of course AWS CloudMap also has the ability to specify exactly which services can access certain backends by integrating IAM into it. But that's for another day to discuss.</p>
</article>
<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18" fill="none" style="top: 4px;position: relative;">
  <path fill-rule="evenodd" clip-rule="evenodd" d="M13.5706 1.07915L12.9519 0.460419L12.3332 1.07914L8.6363 4.77601L9.87373 6.01345L12.0754 3.8118C12.0758 4.19678 12.0764 4.58119 12.077 4.96525V4.9653V4.96533C12.0799 6.74156 12.0828 8.51005 12.063 10.291C11.9514 12.51 10.2821 14.5766 8.13549 15.0249L8.12156 15.0278L8.10773 15.0311C6.21947 15.49 4.06987 14.5395 3.24835 12.8164L3.24176 12.8025L3.23468 12.7889C2.46106 11.3026 2.86462 9.29521 4.17623 8.31823L4.18926 8.30852L4.20193 8.29834C5.33152 7.3898 7.12207 7.44889 8.09598 8.45611L8.10921 8.46979L8.12302 8.48289C8.65152 8.9839 8.85928 9.70255 8.85928 10.7436V10.8568H10.6093V10.7436C10.6093 9.51128 10.3691 8.21034 9.34085 7.22607C7.68339 5.5272 4.88287 5.51577 3.11789 6.92446C1.07968 8.45342 0.548175 11.4013 1.67527 13.5832C2.88159 16.0953 5.88263 17.3657 8.50709 16.735C11.4878 16.1053 13.6724 13.3174 13.8118 10.3583L13.8126 10.3426L13.8127 10.3269C13.8328 8.53249 13.8299 6.73532 13.827 4.94338V4.9431V4.94298C13.8264 4.56468 13.8258 4.18661 13.8254 3.80885L16.03 6.01344L17.2674 4.77602L13.5706 1.07915Z" fill="currentColor"></path>
</svg>
<a href="https://shareopenly.org/share/?url=https://mijndertstuij.nl/posts/avoid-using-internal-load-balancers/&text=Avoid using internal load balancers" title="Share this post via ShareOpenly!">Share this post via ShareOpenly</a>

    </main>
    <footer>
  <hr>
  <p class="muted">Receive updates</p>
  <p>Follow me via <a href="/feed.xml">RSS</a>, <a rel="me" href="https://fosstodon.org/@mijndert">Mastodon</a>, or <a href="/contact">other options</a>.</p>
</footer>
  </body>
</html>
