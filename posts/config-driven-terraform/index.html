<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="Eleventy v2.0.1">
    <title>Config-driven Terraform</title>
    <meta name="description" content="Some improvements in Terraform 1.7: Config-driven Remove and Import block for_each." />
    <link rel="alternate" type="application/rss+xml" href="https://mijndertstuij.nl/feed.xml" />
    <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
    <link rel="manifest" href="favicon/site.webmanifest">
    <link rel="stylesheet" href="/css/base.css" />
    <style>@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap')</style>
  </head>
  <body>
    <header>
  <a class="muted" href="/">Mijndert Stuij</a>
</header>
    <main>
      
<h1>Config-driven Terraform</h1>
<p class="muted">2024.01.18</p>
<article><p>Some time ago I wrote about <a href="https://mijndertstuij.nl/posts/terraform-import-blocks/">config-driven import</a> which became available in Terraform 1.5. Import blocks are a way to import existing resources into the statefile, which is useful when you have a bunch of infrastructure that was created manually. Yesterday <a href="https://www.hashicorp.com/blog/terraform-1-7-adds-test-mocking-and-config-driven-remove">Terraform 1.7 was released</a> that extends this functionality with a <code>for_each</code> argument.</p>
<blockquote>
<p>Terraform 1.7 also includes an enhancement for config-driven import: the ability to expand import blocks using for_each loops. Previously you could target a particular instance of a resource in the to attribute of an import block, but you had to write a separate import block for each instance.</p>
</blockquote>
<p>Expanding on my previous blogpost about Import blocks, here's a quick example of how to use the new <code>for_each</code> argument on a list to import multiple Digitalocean Spaces buckets at once.</p>
<pre><code>terraform {
  required_providers {
    digitalocean = {
      source = &quot;digitalocean/digitalocean&quot;
    }
  }
}

locals {
  buckets = {
    &quot;test&quot; = &quot;bucket-test&quot;
    &quot;staging&quot; = &quot;bucket-staging&quot;
    &quot;prod&quot;    = &quot;bucket-prod&quot;
  }
}

import {
  for_each = local.buckets
  to       = digitalocean_spaces_bucket.mybucket[each.key]
}


resource &quot;digitalocean_spaces_bucket&quot; &quot;mybucket&quot; {
  for_each = local.buckets
  bucket   = each.value
}
</code></pre>
<p>Another great addition in Terraform 1.7 are Remove blocks. There are times when you need to remove a resource from your Statefile, optionally without removing the underlying resource itself. Of course there are CLI commands to accomplish this, but having it available as a Remove block means we can run <code>terraform apply</code> and check the changes before executing them.</p>
<blockquote>
<p>As an alternative to the terraform state rm command, the removed block addresses all of these challenges. Just like the moved and import blocks, state removal can now be performed in bulk and is plannable, so you can be confident that the operation will have the intended effect before modifying state.</p>
</blockquote>
<pre><code>removed {
  from = digitalocean_spaces_bucket.mybucket

  # Instruct Terraform not to destroy the underlying resource
  lifecycle {
    destroy = false
  }
}
</code></pre>
<p>Both of these additions are great improvements to Terraform, and I'm looking forward to using them in my projects. They will ensure I'm much more confident in working with the Statefile which has always been a bit daunting.</p>
</article>
<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18" fill="none" style="top: 4px;position: relative;">
  <path fill-rule="evenodd" clip-rule="evenodd" d="M13.5706 1.07915L12.9519 0.460419L12.3332 1.07914L8.6363 4.77601L9.87373 6.01345L12.0754 3.8118C12.0758 4.19678 12.0764 4.58119 12.077 4.96525V4.9653V4.96533C12.0799 6.74156 12.0828 8.51005 12.063 10.291C11.9514 12.51 10.2821 14.5766 8.13549 15.0249L8.12156 15.0278L8.10773 15.0311C6.21947 15.49 4.06987 14.5395 3.24835 12.8164L3.24176 12.8025L3.23468 12.7889C2.46106 11.3026 2.86462 9.29521 4.17623 8.31823L4.18926 8.30852L4.20193 8.29834C5.33152 7.3898 7.12207 7.44889 8.09598 8.45611L8.10921 8.46979L8.12302 8.48289C8.65152 8.9839 8.85928 9.70255 8.85928 10.7436V10.8568H10.6093V10.7436C10.6093 9.51128 10.3691 8.21034 9.34085 7.22607C7.68339 5.5272 4.88287 5.51577 3.11789 6.92446C1.07968 8.45342 0.548175 11.4013 1.67527 13.5832C2.88159 16.0953 5.88263 17.3657 8.50709 16.735C11.4878 16.1053 13.6724 13.3174 13.8118 10.3583L13.8126 10.3426L13.8127 10.3269C13.8328 8.53249 13.8299 6.73532 13.827 4.94338V4.9431V4.94298C13.8264 4.56468 13.8258 4.18661 13.8254 3.80885L16.03 6.01344L17.2674 4.77602L13.5706 1.07915Z" fill="currentColor"></path>
</svg>
<a href="https://shareopenly.org/share/?url=https://mijndertstuij.nl/posts/config-driven-terraform/&text=Config-driven Terraform" title="Share this post via ShareOpenly!">Share this post via ShareOpenly</a>

    </main>
    <footer>
  <hr>
  <p class="muted">Receive updates</p>
  <p>Follow me via <a href="/feed.xml">RSS</a> or <a href="/contact">other options</a>.</p>
</footer>
  </body>
</html>
