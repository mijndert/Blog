<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="Eleventy v2.0.1">
    <title>Reusable Terraform modules using Dynamic blocks</title>
    <meta name="description" content="Stop repeating yourself and use Dynamic blocks in your Terraform resources" />
    <link rel="alternate" type="application/rss+xml" href="https://mijndertstuij.nl/feed.xml" />
    <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
    <link rel="manifest" href="favicon/site.webmanifest">
    <link rel="stylesheet" href="/css/base.css" />
    <style>@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap')</style>
  </head>
  <body>
    <header>
  <a class="muted" href="/">Mijndert Stuij</a>
</header>
    <main>
      
<h1>Reusable Terraform modules using Dynamic blocks</h1>
<p class="muted">2022.12.08</p>
<article><p>In the realm of Amazon Web Services there's this thing called a <a href="https://docs.aws.amazon.com/prescriptive-guidance/latest/migration-aws-environment/understanding-landing-zones.html">Landing Zone</a>, a set of infrastructure as code modules built to deploy new environments faster. You can build a Landing Zone using <a href="https://aws.amazon.com/cloudformation/">CloudFormation</a>, <a href="https://aws.amazon.com/cdk/">CDK</a>, <a href="https://www.terraform.io">Terraform</a>, or any other tool you like. The point is that you have a starting point for as many use-cases as possible. For a Landing Zone to work you have to write reusable generalized code that could work for any client and any combination of infrastructure.</p>
<p>While trying to create a Landing Zone in Terraform I found that it's very hard to make them follow the <a href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself">DRY principle</a> (Don't Repeat Yourself). After a while the code started to be really hard to maintain. But then I found Dynamic blocks.</p>
<p>Terraform provides <a href="https://developer.hashicorp.com/terraform/language/expressions/dynamic-blocks">Dynamic blocks</a> as a way to create repeatable nested code within a resource, it's kind of similar to a for loop but for stuff within a resource. But Dynamic blocks also allow you to conditionally create certain properties on a resource.</p>
<p>As an example, let's take the <a href="https://github.com/toot-community/platform">platform code for toot.community</a>.</p>
<p>Here I wanted to create multiple <a href="https://www.digitalocean.com/products/spaces">Digitalocean Spaces</a>, one for storing user files, one for backups, one for Terraform state management, etc. On some of these Spaces I want to create a lifecycle rule to automatically delete files older than a given threshold. But of course I don't want to apply that same lifecycle policy to everything; it would be a stupid idea to delete Terraform statefiles after all. At the same time, I really want to define the Digitalocean Spaces resource only once, for DRY reasons.</p>
<p>In this example you see a Dynamic block for the property <code>lifecycle_rule</code>. There's a <code>for_each</code> that needs the variable <code>expiration_enabled</code> to be set to <code>true</code>, else the <code>for_each</code> loop will be empty and the property will not be created.</p>
<pre><code>resource &quot;digitalocean_spaces_bucket&quot; &quot;this&quot; {
  name   = var.spaces_name
  region = var.region
  acl    = &quot;private&quot;

  dynamic &quot;lifecycle_rule&quot; {
    for_each = var.expiration_enabled == true ? [1] : []
    content {
      id      = &quot;${var.spaces_name}-lifecycle-rule&quot;
      enabled = true
      expiration {
        days = 7
      }
      noncurrent_version_expiration {
        days = 7
      }
    }
  }
}
</code></pre>
<p>Now if I don't specify the variable <code>expiration_enabled</code> the <code>lifecycle_rule</code> property isn't created and I just get a standard <code>digitalocean_spaces_bucket</code>. I don't have to repeat myself anymore and it makes my module a lot cleaner.</p>
<p>A word of warning though, overuse of Dynamic blocks will eventually lead to code being unreadable and not very easy to understand. Only use Dynamic blocks if there's no other way to avoid repeating the same code. If you have to repeat a few lines once or twice, stop and think if you really need a Dynamic block or if you can live with it in that instance.</p>
<p>Speaking of Terraform modules, that's something I want to talk about in another blog post as well. A question I get asked a lot is &quot;how do I organize my environments and modules?&quot;. More on that later. If you want to get notified of new posts you can import the <a href="https://mijndertstuij.nl/feed.xml">RSS feed</a> for this website in your reader.</p>
</article>
<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18" fill="none" style="top: 4px;position: relative;">
  <path fill-rule="evenodd" clip-rule="evenodd" d="M13.5706 1.07915L12.9519 0.460419L12.3332 1.07914L8.6363 4.77601L9.87373 6.01345L12.0754 3.8118C12.0758 4.19678 12.0764 4.58119 12.077 4.96525V4.9653V4.96533C12.0799 6.74156 12.0828 8.51005 12.063 10.291C11.9514 12.51 10.2821 14.5766 8.13549 15.0249L8.12156 15.0278L8.10773 15.0311C6.21947 15.49 4.06987 14.5395 3.24835 12.8164L3.24176 12.8025L3.23468 12.7889C2.46106 11.3026 2.86462 9.29521 4.17623 8.31823L4.18926 8.30852L4.20193 8.29834C5.33152 7.3898 7.12207 7.44889 8.09598 8.45611L8.10921 8.46979L8.12302 8.48289C8.65152 8.9839 8.85928 9.70255 8.85928 10.7436V10.8568H10.6093V10.7436C10.6093 9.51128 10.3691 8.21034 9.34085 7.22607C7.68339 5.5272 4.88287 5.51577 3.11789 6.92446C1.07968 8.45342 0.548175 11.4013 1.67527 13.5832C2.88159 16.0953 5.88263 17.3657 8.50709 16.735C11.4878 16.1053 13.6724 13.3174 13.8118 10.3583L13.8126 10.3426L13.8127 10.3269C13.8328 8.53249 13.8299 6.73532 13.827 4.94338V4.9431V4.94298C13.8264 4.56468 13.8258 4.18661 13.8254 3.80885L16.03 6.01344L17.2674 4.77602L13.5706 1.07915Z" fill="currentColor"></path>
</svg>
<a href="https://shareopenly.org/share/?url=https://mijndertstuij.nl/posts/terraform-dynamic-blocks-modules/&text=Reusable Terraform modules using Dynamic blocks" title="Share this post via ShareOpenly!">Share this article on social media</a>

    </main>
    <footer>
  <hr>
  <p class="muted">Receive updates</p>
  <p>Follow me via <a href="/feed.xml">RSS</a>, <a rel="me" href="https://fosstodon.org/@mijndert">Mastodon</a>, or <a href="/contact">other options</a>.</p>
</footer>
  </body>
</html>
